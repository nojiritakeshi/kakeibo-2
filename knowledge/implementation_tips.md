# Flutter家計簿アプリ実装のヒントと修正過程

このドキュメントでは、Flutter家計簿アプリの実装中に遭遇した問題とその解決策について説明します。特に、一度の実装では解決できなかった問題と、フィードバックを受けて修正した過程に焦点を当てています。

## 1. 名前衝突の問題

### 問題
Flutterの`Transaction`クラスとアプリ内の`Transaction`クラスの名前衝突が発生しました。

### 解決策
- アプリ内のクラス名を`Transaction`から`KakeiboTransaction`に変更
- 同様に`Category`クラスも`KakeiboCategory`に変更
- 関連するすべてのファイルで参照を更新

### 学んだこと
- Dartでは、パッケージ間で同じ名前のクラスが存在する場合、明示的にインポートする際にプレフィックスを使用するか、クラス名自体を変更する必要があります。
- プロジェクト固有のプレフィックスをクラス名に付けることで、将来的な名前衝突を防ぐことができます。

## 2. Webプラットフォームでのデータベース問題

### 問題
最初の実装では、モバイルとWebの両方で`sqflite`を使用しようとしましたが、Webプラットフォームでは以下のエラーが発生しました：

```
database_factory_web.dart:91 An error occurred while initializing the web worker.
This is likely due to a failure to find the worker javascript file at sqflite_sw.js
```

### 最初の修正アプローチ（失敗）
1. `sqflite_common_ffi_web`パッケージを追加
2. Webプラットフォーム用に`databaseFactoryFfiWeb`を使用するように修正
3. `web/index.html`にスクリプトタグを追加
4. `web/`ディレクトリに必要なJSファイルのプレースホルダーを作成

しかし、この方法では問題が解決せず、以下のエラーが発生しました：
```
SqfliteFfiWebException()
```

### 最終的な解決策
1. Webプラットフォームでは`sqflite`の代わりに`SharedPreferences`を使用するように完全に書き換え
2. プラットフォーム固有のコードを条件分岐で分離
3. データの永続化方法をプラットフォームごとに最適化

### 学んだこと
- クロスプラットフォーム開発では、すべてのプラットフォームで同じ実装を使おうとするのではなく、プラットフォームごとに最適な実装を選択することが重要です。
- `kIsWeb`フラグを使用して、実行環境に応じてコードの挙動を変えることができます。
- Webプラットフォームでは、ブラウザのストレージAPIを活用するのが効果的です。

## 3. カテゴリ選択の問題

### 問題
カテゴリ選択のUIで、以下の問題が発生しました：
- UI上はすべてのカテゴリにチェックがついているように見える
- 実際には一つも選択されていない
- ログ出力では、カテゴリIDがnullになっていた：
```
現在選択されているカテゴリID: null
利用可能なカテゴリ: null:給料, null:ボーナス, null:副業, null:投資, null:その他
```

### 最初の修正アプローチ（部分的に成功）
1. 初期カテゴリ選択のための`_initializeDefaultCategory`メソッドを追加
2. カテゴリ選択UIの視覚的な改善
3. 選択状態をより明確に表示

しかし、この修正だけでは問題が完全に解決せず、カテゴリIDがnullのままでした。

### 根本的な原因
Webプラットフォームでカテゴリを初期化する際に、カテゴリにIDを設定していませんでした。SQLiteデータベースでは自動的にIDが生成されますが、SharedPreferencesを使用する場合は手動でIDを設定する必要があります。

### 最終的な解決策
1. `_initializeDefaultCategories`メソッドを修正し、カテゴリにIDを明示的に設定
   ```dart
   final expenseCategories = List<Map<String, dynamic>>.generate(
     DefaultCategories.expenses.length,
     (index) {
       final category = DefaultCategories.expenses[index];
       final map = category.toMap();
       map['id'] = index + 1; // IDを1から始まる連番で設定
       return map;
     }
   );
   ```
2. アプリ起動時にカテゴリデータをリセットするコードを追加
   ```dart
   if (kIsWeb) {
     final prefs = await SharedPreferences.getInstance();
     await prefs.remove('categories_initialized');
   }
   ```
3. デバッグ情報を追加して、カテゴリIDの設定を確認

### 学んだこと
- データモデルでは、IDの生成と管理を明示的に行うことが重要です。
- 異なるストレージ方法（SQLiteとSharedPreferences）では、データの永続化と取得の方法が異なります。
- デバッグ情報を追加することで、問題の根本原因を特定しやすくなります。

## 4. コードの品質と保守性に関するヒント

### セミコロンとカンマの正しい使用
コード内で`,`と`;`が正しく使われていないことがあり、実行エラーの原因となりました。Dartでは：
- `;`はステートメントの終わりに使用
- `,`はリスト、マップ、パラメータリストの要素を区切るために使用

### 非同期処理の適切な管理
- `async`/`await`を使用して非同期処理を簡潔に記述
- `Future.microtask`を使用して、UIの更新後に処理を実行

### プラットフォーム固有のコードの分離
```dart
if (kIsWeb) {
  // Webプラットフォーム固有の実装
} else {
  // モバイルプラットフォーム固有の実装
}
```

### デバッグ情報の活用
問題解決のために、適切な場所にデバッグ情報を出力することが重要です：
```dart
print('現在選択されているカテゴリID: $_selectedCategoryId');
print('利用可能なカテゴリ: ${categories.map((c) => '${c.id}:${c.name}').join(', ')}');
```

## 5. UIの改善に関するヒント

### 視覚的なフィードバックの強化
- 選択状態を明確に表示するために、色、影、テキストスタイルを活用
- 状態に応じてUIの外観を変更（選択されたカテゴリは背景色が変わるなど）

### エラーメッセージの明確化
- ユーザーが理解しやすいエラーメッセージを表示
- 問題が発生した場合の対処方法を提示

### 初期状態の適切な設定
- 画面表示時に適切な初期値を設定
- ユーザーが混乱しないように、選択状態を明確に表示

## まとめ

Flutterを使用したクロスプラットフォームアプリ開発では、以下の点に注意することが重要です：

1. **プラットフォーム固有の問題に対応する**：各プラットフォームの特性を理解し、適切な実装を選択する
2. **データの永続化を適切に管理する**：プラットフォームごとに最適なストレージ方法を選択する
3. **UIの一貫性を保つ**：すべてのプラットフォームで一貫したユーザー体験を提供する
4. **デバッグ情報を活用する**：問題の特定と解決のために、適切なデバッグ情報を出力する
5. **フィードバックを活かす**：ユーザーからのフィードバックを元に、継続的に改善する

これらの点に注意することで、より堅牢で使いやすいFlutterアプリを開発することができます。
